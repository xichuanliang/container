<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/container.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/container.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/container.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/container.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="/container.github.io/css/main.css">


<link rel="stylesheet" href="/container.github.io/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xichuanliang.github.io","root":"/container.github.io/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="该文只介绍clusterctl的generate命令，源码在cluster-api中。以下分析仅作参考。同时，在https:&#x2F;&#x2F;github.com&#x2F;xichuanliang&#x2F;yamlv1中提取了clusterctl gengerate的代码用于读取本地template文件和conf文件，初始化templateclusterctl generate用于根据给定的template生成对应的yaml，">
<meta property="og:type" content="article">
<meta property="og:title" content="Clusterctl gengerate">
<meta property="og:url" content="https://xichuanliang.github.io/container.github.io/2023/11/11/sealos/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="该文只介绍clusterctl的generate命令，源码在cluster-api中。以下分析仅作参考。同时，在https:&#x2F;&#x2F;github.com&#x2F;xichuanliang&#x2F;yamlv1中提取了clusterctl gengerate的代码用于读取本地template文件和conf文件，初始化templateclusterctl generate用于根据给定的template生成对应的yaml，">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-11-11T14:31:52.000Z">
<meta property="article:modified_time" content="2023-11-28T15:39:07.340Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://xichuanliang.github.io/container.github.io/2023/11/11/sealos/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Clusterctl gengerate | Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/container.github.io/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/container.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/container.github.io/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xichuanliang.github.io/container.github.io/2023/11/11/sealos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/container.github.io/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Clusterctl gengerate
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-11-11 22:31:52" itemprop="dateCreated datePublished" datetime="2023-11-11T22:31:52+08:00">2023-11-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-28 23:39:07" itemprop="dateModified" datetime="2023-11-28T23:39:07+08:00">2023-11-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>该文只介绍clusterctl的generate命令，源码在cluster-api中。以下分析仅作参考。<br>同时，在<a target="_blank" rel="noopener" href="https://github.com/xichuanliang/yamlv1%E4%B8%AD%E6%8F%90%E5%8F%96%E4%BA%86clusterctl">https://github.com/xichuanliang/yamlv1中提取了clusterctl</a> gengerate的代码用于读取本地template文件和conf文件，初始化template<br>clusterctl generate用于根据给定的template生成对应的yaml，从而创建cluster-api所需的yaml资源，如cluster、machinedeployment、kubeadmcontrolplane等。上述资源供cluster-api生成一个k8s集群。</p>
<ul>
<li><p>clustectl中的命令都是基于cobra框架而生成的</p>
</li>
<li><p>在cobra框架中RunE代表在执行该命令的时候，执行的函数。RunE表示该命令能够返回错误信息。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> generateClusterClusterCmd = &amp;cobra.Command&#123;</span><br><span class="line">	Use:   <span class="string">&quot;cluster NAME&quot;</span>,</span><br><span class="line">	Short: <span class="string">&quot;Generate templates for creating workload clusters&quot;</span>,</span><br><span class="line">	Long: LongDesc(<span class="string">`</span></span><br><span class="line"><span class="string">		Generate templates for creating workload clusters.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		clusterctl ships with a list of known providers; if necessary, edit</span></span><br><span class="line"><span class="string">		$XDG_CONFIG_HOME/cluster-api/clusterctl.yaml to add new provider or to customize existing ones.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		Each provider configuration links to a repository; clusterctl uses this information</span></span><br><span class="line"><span class="string">		to fetch templates when creating a new cluster.`</span>),</span><br><span class="line"></span><br><span class="line">	Example: Examples(<span class="string">`</span></span><br><span class="line"><span class="string">		# Generates a yaml file for creating workload clusters using</span></span><br><span class="line"><span class="string">		# the pre-installed infrastructure and bootstrap providers.</span></span><br><span class="line"><span class="string">		clusterctl generate cluster my-cluster</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	Args: func(cmd *cobra.Command, args []string) error &#123;</span></span><br><span class="line"><span class="string">		if len(args) != 1 &#123;</span></span><br><span class="line"><span class="string">			return errors.New(&quot;please specify a cluster name&quot;)</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">		return nil</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	RunE: func(cmd *cobra.Command, args []string) error &#123;</span></span><br><span class="line"><span class="string">		return runGenerateClusterTemplate(cmd, args[0])</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>runGenerateClusterTemplate命令用于根据template生成一个yaml</p>
</li>
<li><p>该方法中最重要的便是GetClusterTemplate()方法，用于生成template。其中templateOptions对template做一些template初始化的选项，比如设置负载集群K8s的版本、master节点个数，负载集群的namespace等等。这些参数都将作用于template。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runGenerateClusterTemplate</span><span class="params">(cmd *cobra.Command, name <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	<span class="comment">// 用于生成configClient</span></span><br><span class="line">	c, err := client.New(ctx, cfgFile)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	templateOptions := client.GetClusterTemplateOptions&#123;</span><br><span class="line">		Kubeconfig:        client.Kubeconfig&#123;Path: gc.kubeconfig, Context: gc.kubeconfigContext&#125;,</span><br><span class="line">		ClusterName:       name,</span><br><span class="line">		TargetNamespace:   gc.targetNamespace,</span><br><span class="line">		KubernetesVersion: gc.kubernetesVersion,</span><br><span class="line">		ListVariablesOnly: gc.listVariables,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> cmd.Flags().Changed(<span class="string">&quot;control-plane-machine-count&quot;</span>) &#123;</span><br><span class="line">		templateOptions.ControlPlaneMachineCount = &amp;gc.controlPlaneMachineCount</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> cmd.Flags().Changed(<span class="string">&quot;worker-machine-count&quot;</span>) &#123;</span><br><span class="line">		templateOptions.WorkerMachineCount = &amp;gc.workerMachineCount</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> gc.url != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		templateOptions.URLSource = &amp;client.URLSourceOptions&#123;</span><br><span class="line">			URL: gc.url,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> gc.configMapNamespace != <span class="string">&quot;&quot;</span> || gc.configMapName != <span class="string">&quot;&quot;</span> || gc.configMapDataKey != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		templateOptions.ConfigMapSource = &amp;client.ConfigMapSourceOptions&#123;</span><br><span class="line">			Namespace: gc.configMapNamespace,</span><br><span class="line">			Name:      gc.configMapName,</span><br><span class="line">			DataKey:   gc.configMapDataKey,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> gc.infrastructureProvider != <span class="string">&quot;&quot;</span> || gc.flavor != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		templateOptions.ProviderRepositorySource = &amp;client.ProviderRepositorySourceOptions&#123;</span><br><span class="line">			InfrastructureProvider: gc.infrastructureProvider,</span><br><span class="line">			Flavor:                 gc.flavor,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	template, err := c.GetClusterTemplate(ctx, templateOptions)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> gc.listVariables &#123;</span><br><span class="line">		<span class="keyword">return</span> printVariablesOutput(template, templateOptions)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> printYamlOutput(template, gc.output)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>GetClusterTemplate()根据templateOptions初始化template</p>
</li>
<li><p>在该方法中会生成clusterClient。这是一个函数类型，最重要的是根据options构造了ClusterClientFactoryInput{options.Kubeconfig, options.YamlProcessor}结构体。其中YamlProcessor会对template进行真正的初始化。</p>
</li>
<li><p>该方法中会选择一个template源进行初始化，本文主要讲解使用固定的template文件进行初始化，即通过URL获取template源。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *clusterctlClient)</span></span> GetClusterTemplate(ctx context.Context, options GetClusterTemplateOptions) (Template, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// 检查template的来源个数，template可以从provider repository、configMap、URL中获取</span></span><br><span class="line">    <span class="comment">// 如果template来源大于1是无法选择template进行初始化的</span></span><br><span class="line">	numsSource := options.numSources()</span><br><span class="line">	<span class="keyword">if</span> numsSource &gt; <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;invalid cluster template source: only one template can be used at time&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> numsSource == <span class="number">0</span> &#123;</span><br><span class="line">		options.ProviderRepositorySource = &amp;ProviderRepositorySourceOptions&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 生成clusterClient</span></span><br><span class="line">	clusterClient, err := c.clusterClientFactory(ClusterClientFactoryInput&#123;options.Kubeconfig, options.YamlProcessor&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 对options中的某些字段进行校验，如果没有或不符合规则就返回错误信息</span></span><br><span class="line">	<span class="keyword">if</span> options.TargetNamespace == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := clusterClient.Proxy().CheckClusterAvailable(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">&quot;management cluster not available. Cannot auto-discover target namespace. Please specify a target namespace&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		currentNamespace, err := clusterClient.Proxy().CurrentNamespace()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> currentNamespace == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;failed to identify the current namespace. Please specify a target namespace&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		options.TargetNamespace = currentNamespace</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将参数中的某些变量注入进clusterClient的configClient中</span></span><br><span class="line">	<span class="keyword">if</span> err := c.templateOptionsToVariables(options); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 选择一个template源</span></span><br><span class="line">	<span class="keyword">if</span> options.ProviderRepositorySource != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// Ensure this command only runs against management clusters with the current Cluster API contract.</span></span><br><span class="line">		<span class="comment">// <span class="doctag">NOTE:</span> This command tolerates also not existing cluster (Kubeconfig.Path==&quot;&quot;) or clusters not yet initialized in order to allow</span></span><br><span class="line">		<span class="comment">// users to dry-run the command and take a look at what the cluster will look like; in both scenarios, it is required</span></span><br><span class="line">		<span class="comment">// to pass provider:version given that auto-discovery can&#x27;t work without a provider inventory installed in a cluster.</span></span><br><span class="line">		<span class="keyword">if</span> options.Kubeconfig.Path != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err := clusterClient.ProviderInventory().CheckCAPIContract(ctx, cluster.AllowCAPINotInstalled&#123;&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> c.getTemplateFromRepository(ctx, clusterClient, options)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> options.ConfigMapSource != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> c.getTemplateFromConfigMap(ctx, clusterClient, *options.ConfigMapSource, options.TargetNamespace, options.ListVariablesOnly)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 通过URL获取template源</span></span><br><span class="line">	<span class="keyword">if</span> options.URLSource != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> c.getTemplateFromURL(ctx, clusterClient, *options.URLSource, options.TargetNamespace, options.ListVariablesOnly)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;unable to read custom template. Please specify a template source&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据template源，将template读取到内存中</p>
</li>
<li><p>最重要的是初始化TemplateInput{}，然后执行repository.NewTemplate，对template进行初始化</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *clusterctlClient)</span></span> getTemplateFromURL(ctx context.Context, cluster cluster.Client, source URLSourceOptions, targetNamespace <span class="type">string</span>, listVariablesOnly <span class="type">bool</span>) (Template, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> cluster.Template().GetFromURL(ctx, source.URL, targetNamespace, listVariablesOnly)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *templateClient)</span></span> GetFromURL(ctx context.Context, templateURL, targetNamespace <span class="type">string</span>, skipTemplateProcess <span class="type">bool</span>) (repository.Template, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> templateURL == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;invalid GetFromURL operation: missing templateURL value&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 根据URL读取template到内存中</span></span><br><span class="line">	content, err := t.getURLContent(ctx, templateURL)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrapf(err, <span class="string">&quot;invalid GetFromURL operation&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 初始化NewTemplate</span></span><br><span class="line">	<span class="keyword">return</span> repository.NewTemplate(repository.TemplateInput&#123;</span><br><span class="line">		RawArtifact:           content, <span class="comment">// 读取的内容</span></span><br><span class="line">		ConfigVariablesClient: t.configClient.Variables(), </span><br><span class="line">		Processor:             t.processor, <span class="comment">// 执行template的初始化</span></span><br><span class="line">		TargetNamespace:       targetNamespace, <span class="comment">// 负载集群的namespace</span></span><br><span class="line">		SkipTemplateProcess:   skipTemplateProcess, <span class="comment">// 是否不使用TemplateProcess，即不使用t.processor对模板进行处理</span></span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 没什么特别的，就是读取template</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *templateClient)</span></span> getURLContent(ctx context.Context, templateURL <span class="type">string</span>) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> templateURL == <span class="string">&quot;-&quot;</span> &#123;</span><br><span class="line">		b, err := io.ReadAll(os.Stdin)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrapf(err, <span class="string">&quot;failed to read stdin&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> b, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rURL, err := url.Parse(templateURL)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrapf(err, <span class="string">&quot;failed to parse %q&quot;</span>, templateURL)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> rURL.Scheme == <span class="string">&quot;https&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> rURL.Host == <span class="string">&quot;github.com&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> t.getGitHubFileContent(ctx, rURL)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> t.getRawURLFileContent(ctx, templateURL)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> rURL.Scheme == <span class="string">&quot;file&quot;</span> || rURL.Scheme == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> t.getLocalFileContent(rURL)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, errors.Errorf(<span class="string">&quot;unable to read content from %q. Only reading from GitHub and local file system is supported&quot;</span>, templateURL)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *templateClient)</span></span> getLocalFileContent(rURL *url.URL) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	f, err := os.Stat(rURL.Path)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Errorf(<span class="string">&quot;failed to read file %q&quot;</span>, rURL.Path)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> f.IsDir() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Errorf(<span class="string">&quot;invalid path: file %q is actually a directory&quot;</span>, rURL.Path)</span><br><span class="line">	&#125;</span><br><span class="line">	content, err := os.ReadFile(rURL.Path)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrapf(err, <span class="string">&quot;failed to read file %q&quot;</span>, rURL.Path)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> content, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化template</p>
</li>
<li><p>input.Processor.GetVariables()，根据input读取到的content，提取变量到[]string中</p>
</li>
<li><p>input.Processor.GetVariableMap()，根据input读取到的content，将各个变量提取到map中</p>
</li>
<li><p>input.Processor.Process()，对模板进行初始化</p>
</li>
<li><p>utilyaml.ToUnstructured()，将读取到的yaml转化为k8s中的unstructured.Unstructured类型</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTemplate</span><span class="params">(input TemplateInput)</span></span> (Template, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 根据input读取到的content，对各个变量提取到[]string中</span></span><br><span class="line">	variables, err := input.Processor.GetVariables(input.RawArtifact)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 根据input读取到的content，将各个变量提取到map中</span></span><br><span class="line">	variableMap, err := input.Processor.GetVariableMap(input.RawArtifact)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 如果上文的SkipTemplateProcess为true，则不用提供的process方法对template进行初始化</span></span><br><span class="line">	<span class="keyword">if</span> input.SkipTemplateProcess &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;template&#123;</span><br><span class="line">			variables:       variables,</span><br><span class="line">			variableMap:     variableMap,</span><br><span class="line">			targetNamespace: input.TargetNamespace,</span><br><span class="line">		&#125;, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 对模板进行初始化</span></span><br><span class="line">	processedYaml, err := input.Processor.Process(input.RawArtifact, input.ConfigVariablesClient.Get)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将读取到的yaml转化为k8s中的unstructured.Unstructured类型</span></span><br><span class="line">	objs, err := utilyaml.ToUnstructured(processedYaml)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">&quot;failed to parse yaml&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> input.TargetNamespace != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="comment">// Ensures all the template components are deployed in the target namespace (applies only to namespaced objects)</span></span><br><span class="line">		<span class="comment">// This is required in order to ensure a cluster and all the related objects are in a single namespace, that is a requirement for</span></span><br><span class="line">		<span class="comment">// the clusterctl move operation (and also for many controller reconciliation loops).</span></span><br><span class="line">		objs, err = fixTargetNamespace(objs, input.TargetNamespace)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">&quot;failed to set the TargetNamespace in the template&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 初始化template，其中objs中存放的就是即将在K8s中创建的资源</span></span><br><span class="line">	<span class="keyword">return</span> &amp;template&#123;</span><br><span class="line">		variables:       variables,</span><br><span class="line">		variableMap:     variableMap,</span><br><span class="line">		targetNamespace: input.TargetNamespace,</span><br><span class="line">		objs:            objs,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/container.github.io/2023/11/04/my-first-blog/" rel="prev" title="接口型函数在http服务中的使用">
      <i class="fa fa-chevron-left"></i> 接口型函数在http服务中的使用
    </a></div>
      <div class="post-nav-item">
    <a href="/container.github.io/2024/01/07/kubeadmInit-%E4%B8%80/" rel="next" title="kubeadmInit (一)">
      kubeadmInit (一) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/container.github.io/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/container.github.io/lib/anime.min.js"></script>
  <script src="/container.github.io/lib/velocity/velocity.min.js"></script>
  <script src="/container.github.io/lib/velocity/velocity.ui.min.js"></script>

<script src="/container.github.io/js/utils.js"></script>

<script src="/container.github.io/js/motion.js"></script>


<script src="/container.github.io/js/schemes/pisces.js"></script>


<script src="/container.github.io/js/next-boot.js"></script>




  















  

  

</body>
</html>
